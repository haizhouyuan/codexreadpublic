# 个人助理项目需求与设计规格（V1 草稿）

## 0. 已确认决策（截至 V1）

- 本仓库范围：实现 **配置/文档/Skills/脚本** + **`tasks` MCP server（本仓库实现）** + **`video_pipeline` MCP server（本仓库实现）**。
- （可选）`glm_router` MCP：本仓库实现，用于把智谱 GLM 当作“低成本加工工具”（免费→付费回退），不替代 Codex 主模型（见 `glm-router-mcp-spec.md`）。
- （可选）`websearch_router` MCP：本仓库实现，用于把 Brave/Tavily/夸克 IQS/GLM web_search/DashScope 等搜索后端做成**成本/配额可控的结构化 SERP 工具**（free → quota → paid 回退；见 `websearch-router-mcp-spec.md`）。
- （可选）`source_pack` MCP：本仓库实现，用于把“URL 线索”抓取并落盘为可审计的证据包（manifest/raw/text/links），作为 digest/claim ledger 的可核验输入（见 `source-pack-mcp-spec.md`）。
- （可选）`tmux_orchestrator` MCP：本仓库实现，用于在 tmux 中以“作业方式”确定性调度 worker（避免 TUI 键盘注入；见 `tmux-orchestrator-mcp-spec.md`）。
- `mem0-memory` MCP：在其他项目中已实现，本仓库仅 **复用配置与接口契约**（不在本仓库实现）。
- `web-research` MCP：在其他项目中已实现（参考 `projects/chatgptMCP`），本仓库仅 **对接其工具接口与工作流约束**（见 `web-research-mcp-spec.md`）。
- Research Dashboard（Web，可视化）：本仓库实现一个**只读**浏览界面（默认端口 `8787`），用于展示 topic/digests/tasks（见 `dashboard-web-spec.md`）。
- 投研收敛（可选但推荐）：在 topic 内产出 `investing.md`（细分赛道→公司池→KPI→催化剂→风险→下一步核验），并聚合到 `archives/investing/`（universe/watchlist/decisions）。投资决策包规范见 `decision-package-spec.md`。
- `user_id`：已确定跨项目统一的主体 ID（仍要求从配置注入，避免写死在代码里）：
  - `U1_USER_ID=family_u1`
  - `CHILD_USER_ID=family_child`
- 孩子数据：上游 App 尚未完成，M4 的输入数据格式先以“暂定 schema”描述，后续以实际落地为准。
- 对伴学机器人侧的更新：本项目只生成“变更包”，必须 **人工审核后再应用**（不自动改机器人项目）。
- 变更包格式：采用 **JSON**（可机器读取、可审阅、可回放）。
- 视频内容：通过本仓库实现的 `video_pipeline` MCP 在本地完成 ASR/OCR/证据包生成；下载/抓取仍是独立步骤（先落到 `imports/content/videos/`）。摘要与关键信息提取由 Codex 调度工具完成：
  - handoff（质量优先/不走 API 计费）：优先用 `web-research`（chatgptMCP：ChatGPT Pro + Gemini Web 登录态）基于 `transcript.json` + `evidence_compact.md` 生成研报式 digest；
  - 批处理/低价值视频：可用启发式摘录或 `glm_router_write_file` 生成初稿（写盘不回流），关键视频再 handoff 审计收敛。
- 主题研究档案：采用 **文件系统（档案）+ mem0（长期记忆）** 的混合策略。
- 信息源策略：写入本规格（`spec.md`），作为回答与记录的约束。

## 0.1 视频下载（工作流补充）

本仓库不把“下载视频”塞进 `video_pipeline` MCP（`video_pipeline` 只处理本地文件），但提供一个**工作流脚本**用于批量把公开视频下载到约定目录，再交给流水线处理：

- 脚本：`scripts/bilibili_up_batch.py`
- 默认下载目录：`imports/content/videos/bilibili/<mid>/`（不入 git）
- 默认分析输出：`state/video-analyses/<analysis_id>/`（不入 git）
- 幂等：使用 `state/video-download-archives/bilibili_<mid>.txt` 作为 `yt-dlp --download-archive`，重复运行会跳过已下载项


## 1. 文档目的与范围

### 1.1 文档目的

- 本文档用于规范一个基于 Codex CLI 的「个人 AI 助理」项目的需求和设计规格。
- 该项目主要服务于用户 U1（你本人）的长期思考、知识积累、行业与技术研究，以及对孩子成长的观察与支持。
- 后续所有代码（MCP server、Skills、脚本等）的设计与实现，应优先参考本规格，而不是临时发挥。

### 1.2 系统范围

- 本项目包含：
  - 一个基于 Codex CLI 的个人助理 Agent；
  - 一组工具层 MCP（至少包含 `tasks` / `video_pipeline`；并通过外部 `mem0-memory` 访问 mem0）及必要的内置 Tools 使用约束；
  - 用于支撑投研、技术研究、个人成长和亲子教育反思的工作流（通过 Skills 等机制表达）。
  - 一个只读的 Research Dashboard（Web）用于可视化浏览研究资产（topic/digests/tasks）。

- 本项目不包含：
  - 儿子的伴学机器人本身的实现（前端、对话逻辑、提示词设计等）；
  - 学校课程、刷题、考试相关的自动化教学功能。
  - `mem0-memory` MCP 的实现（由外部项目提供，本仓库仅对接）。
  - 视频抓取/登录态字幕抓取（B 站/YouTube 等）与云端转写服务（本项目仅处理本地视频文件并产出证据包）。

### 1.3 与其他项目的边界

- 伴学机器人项目在单独的代码库/环境中开发，本项目只通过 **mem0 MCP** 与其共享信息：
  - 从伴学机器人的对话记录中提取结构化信息和长期记忆（孩子的兴趣、情绪变化、习惯等）；
  - 为伴学机器人更新系统提示词片段和长期记忆（以统一接口形式输出）；
  - 为 U1 提供基于这些信息的育儿建议和决策支持。
- mem0 MCP 的具体实现已在其他项目中完成，本项目将复用该 MCP，并在配置中引用（不在本仓库实现）。
- 对伴学机器人侧的输出以“变更包（JSON）”形式落地，默认写入仓库的导出目录，供你人工审核与应用。

## 2. 系统总体愿景与目标

### 2.1 愿景

- 搭建一个围绕 U1 的「个人智能工作台」，长期陪伴你在以下几个方向持续进步：
  - 投资与行业研究（含主题研究，如航天等）；
  - 前沿科技理解与跟踪；
  - 个人决策与知识管理（第二大脑）；
  - 对孩子成长的观察、反思与行动建议。
- 系统不局限于“投研 Agent”，而是一个综合的个人助理，其中投研是一个重要模块。

### 2.2 核心目标

- 知识与信息层面：
  - 将你阅读/收集的文章、视频、报告等内容进行统一的后处理与归纳，提炼出对你有用的结构化信息，并写入 mem0 中 U1 的长期记忆；
  - 为行业与主题研究建立可复用的研究框架，并持续更新相关知识结构。

- 决策与行动层面：
  - 帮你从碎片化想法和问题中，提取出可执行的任务和研究议题；
  - 对孩子成长（心理发展、兴趣、习惯）提供分析和建议，辅助你做出更好的教育决策。

- 工程与维护层面（实现要求）：
  - 所有工具调用（特别是 MCP）都有明确的接口规格；
  - 工作流尽量通过 Skills/SOP 表达，便于复用、演化和审查。

### 2.3 非目标

- 系统不会：
  - 自动做投资决策或下单；
  - 替代学校教育或系统性教学；
  - 主动对孩子进行高强度的学业规划（至少在当前阶段不是目标）。

### 2.4 信息源策略（偏见控制）

- 信息源优先级（从高到低）：
  1. 官方与监管披露（年报/季报/公告/监管文件等）
  2. 一手材料（电话会 transcript、Investor Day、官方技术白皮书/演讲稿）
  3. 高质量数据源（统计口径明确、可复核的公开数据）
  4. 研究机构研报（作为观点与线索，不作为唯一事实来源）
  5. 媒体/自媒体（仅作线索与情绪参考）
- 对需要引用外部信息的回答，应输出“来源清单（链接/出处）+ 不确定性提示”。

## 3. 用户与使用场景

### 3.1 用户与角色

- **U1：你本人（成人用户/父亲/研究者）**
  - 使用 Codex CLI 进行日常对话、研究和管理；
  - 领域兴趣：投资、行业研究、前沿科技、亲子教育。

- **A1：个人助理 Agent**
  - 运行在 Codex CLI 上，通过配置、AGENTS.md、Skills 形成一个持续演化的 Agent；
  - 负责调度工具、整理知识、生成文档、更新记忆。

- **外部系统：伴学机器人 + mem0**
  - 伴学机器人项目在其他代码库中开发，本项目不直接控制它的对话逻辑；
  - mem0 作为持久化记忆层，同时存：
    - U1 的长期知识与偏好；
    - 对孩子（包括其在伴学机器人中的行为和状态）的长期观察与总结。
  - 视频类内容：本仓库通过 `video_pipeline` MCP 产出证据包；摘要/沉淀由本仓库 Skills 处理。

### 3.2 典型使用场景（当前版本）

- **S1：碎片化想法与问题捕获（通用，不限于投研）**
  - 场景：你在任意时间想到问题/灵感（关于投资、技术、育儿、自我成长等）。
  - 期望行为：
    - 助理 Agent 将自然语言输入归类（主题、类型），压缩成结构化记录；
    - 视情况写入：
      - 任务系统（研究/行动事项）；
      - mem0（长期记忆：观点、偏好、反思）。

- **S2：内容消化与第二大脑更新（文章/视频/报告后处理）**
  - 场景：你阅读/收藏一篇文章、一个视频（含转录）、一份研报或博客。
  - 期望行为：
    - Agent 协助完成：
      - 抽取结构化摘要（核心观点、证据、反驳点、适用条件）；
      - 标记与现有知识结构的关联（哪个行业、哪条主题研究、哪些公司/技术相关）；
      - 提取出对你有长期价值的部分写入 mem0（U1 记忆）。
    - 对投研与技术相关内容，可同时更新行业/主题研究的进展记录。
  - 备注：视频类输入优先使用“已提供的转录/正文”；若输入为本地视频文件，则先运行 `video_pipeline.analyze_video` 生成 `evidence_compact.md` / `key_metrics.csv`，再进入本模块。

- **S3：行业研究与主题研究（投研模块）**
  - 场景：你希望系统性地研究某个行业（如半导体、云计算）或某个主题（如航天）。
  - 期望行为：
    - 为某行业/主题建立并维护研究框架：
      - 关键问题列表（技术、历史、商业模式、竞争格局、政策、投资逻辑等）；
      - 重要实体（公司/技术/事件）的清单；
      - 持续更新的“进展日志”（有哪些新事件、新论文、新产品）。
    - Agent 帮你把新资料（文章/报告）挂到对应框架下，梳理“目前已知/未知的部分”，并给出下一步建议。

- **S4：一般投研问答与分析**
  - 场景：你针对某公司/赛道提出问题（估值、竞争、技术路线等）。
  - 期望行为：
    - Agent 结合：
      - 本地/远程资料（后续 MCP：文档库、图谱、行情数据）；
      - mem0 中 U1 的历史观点和偏好；
    - 输出结构化回答，并在适当时更新：
      - 该公司/赛道的“Thesis 记录”；
      - 你的投资偏好/原则的长期记忆。

- **S5：孩子成长观察与育儿建议**
  - 场景：伴学机器人与孩子的对话在另一个系统中进行；上游 App 尚未完成，本项目暂以“导入对话摘要/日志文件”的方式接入；同时你也会在本项目中记录自己的观察与感受。
  - 期望行为：
    - Agent 对这些信息做后处理：
      - 提取孩子的兴趣点、情绪状态、行为模式（倾向回避什么、喜欢什么）；
      - 识别近期的变化（例如更焦虑/更自信/对某领域兴趣上升）。
    - 对 U1：
      - 给出基于儿童心理发展视角的建议（如何陪伴、如何回应某类问题）；
      - 帮你反思自己的回应方式，形成“养育原则”的长期总结，并写入 mem0（U1 记忆）。
    - 对伴学机器人：
      - 生成可供另一项目使用的“系统提示词补丁”和“长期记忆更新建议”，以统一格式输出，方便你在那边更新机器人配置。

## 4. 系统架构概览

### 4.1 分层架构

系统采用分层结构，主要包含四层：

1. **交互层（Interaction Layer）**
   - 形态：
     - Codex CLI TUI（本机或 ssh 到 NAS 上运行）。
     - 非交互模式 `codex exec` 用于批处理（如夜间 ingest）。
   - 职责：
     - 接收 U1 自然语言输入（问题、想法、指令）。
     - 展示 Agent 的推理、计划、执行过程和结果。
     - 在需要时请求 U1 确认（如高风险命令）。

2. **Agent & 工作流层（Agent & Workflow Layer）**
   - 形态：
     - Codex 内置的 agent 行为（通过配置、AGENTS.md、模型选择实现）。
     - Skills（`SKILL.md` 文件）定义的可复用工作流和 SOP。
   - 职责：
     - 解释 U1 的意图，将其映射到一个或多个工作流（如：捕获想法、消化内容、更新研究框架、亲子反思）。
     - 组合调用 MCP 工具和内置工具，执行多步任务。
     - 决定何时更新长期记忆、何时仅做一次性回答。

3. **工具 & MCP 层（Tools & MCP Layer）**
   - 形态：
     - Codex 内置 Tools：`shell`、`python`、`web_search`、`workspace` 等。
     - 本仓库实现的 MCP servers：
       - `tasks`：研究任务与行动项管理。
       - `video_pipeline`：本地视频后处理（ASR/OCR/证据包）。
       - （可选）`websearch_router`：成本/配额可控的结构化 SERP 搜索（free → quota → paid 回退；用于快速找一手来源）。
       - （可选）`source_pack`：URL → 证据包（manifest/raw/text/links）落盘；抓取失败也要留证并结构化标记原因，避免深挖停摆。
       - （可选）`glm_router`：智谱 GLM “加工工具”（免费→付费回退；用于结构化加工/填模板，不替代 Codex 主模型）。
       - （可选）`tmux_orchestrator`：tmux worker 调度（作业方式；用于多 topic 并行；避免往 TUI 注入键盘事件）。
     - 外部复用的 MCP servers：
       - `mem0-memory`：访问 mem0/OpenMemory（U1 和孩子相关记忆）。
       - `web-research`：获取公开信息/事实核查/观点调研/Deep Research（参考实现见 `projects/chatgptMCP`；接口约束见 `web-research-mcp-spec.md`）。
     - （可选/后续）`kb-rag`：文档库 + RAG。
     - （可选/后续）`kg-graph`：行业/主题知识图谱。
     - （可选/后续）`finance-data`：行情与财务数据。
   - 职责：
     - 提供统一、明确定义的接口用于读写数据与调用外部能力。
     - 隔离 Codex agent 与具体实现（如换行情 API 只需改 MCP 实现）。

4. **数据 & 记忆层（Data & Memory Layer）**
   - 形态：
     - NAS 文件系统：
       - 原始资料：文章、PDF、转录等。
       - 导出的研究笔记、日志、配置片段。
     - 数据库/服务：
       - mem0/OpenMemory：持久化 U1 与孩子相关的长期记忆。
       - （可选）Postgres/pgvector、Qdrant、图数据库等。
   - 职责：
     - 持久保存所有对 U1 有长期价值的信息。
     - 为工具层提供可靠的数据源和存储后端。

### 4.2 核心子系统与模块

- **CS1：个人助理 Agent（基于 Codex CLI）**
  - 运行环境：Codex CLI + 配置 + AGENTS.md + Skills。
  - 能力范围：
    - 通用问答与推理。
    - 投研与技术研究。
    - 内容消化与第二大脑更新。
    - 孩子成长观察与育儿建议。
    - 任务与行动项管理。

- **CS2：记忆与第二大脑子系统**
  - 基于 mem0/OpenMemory（通过 `mem0-memory` MCP）。
- 区分不同的记忆主体：
  - `U1_USER_ID`：你自己的长期记忆（实际值由配置提供）。
  - `CHILD_USER_ID`：孩子相关的长期记忆（实际值由配置提供）。
  - 命名约定（已确认跨项目统一）：`family_u1` / `family_child`（仍可按需覆盖）。
  - 负责存储：
    - U1 的长期知识、偏好、原则、反思。
    - 对孩子的长期观察和总结。

- **CS3：任务与工作流管理子系统**
  - 基于 `tasks` MCP + Skills。
  - 将碎片化输入结构化为任务、主题研究议题、跟进事项。

- **CS4：知识输入与研究框架子系统**
  - （阶段性演进）包括：
    - 内容 ingest（文章/视频/报告）。
    - 行业与主题研究框架管理。
    - 相关数据结构（可用 RAG/图谱支撑）。

- **CS5：研究 Dashboard（Web，可视化，只读）**
  - 目标：把 `archives/topics/<topic_id>/`（overview/framework/sources/timeline/open_questions/digests）与（可选）`state/tasks.sqlite` 以只读方式可视化，方便浏览“研究过程 + 结论 + 下一步行动”。
  - 运行端口：默认 `8787`（可配置）。
  - 安全边界：目录白名单 + 对外开放必须认证（见 `dashboard-web-spec.md` 与 `privacy-retention-spec.md` 的访问控制建议）。

### 4.3 与外部系统的集成方式

- **mem0/OpenMemory**
  - 通过 `mem0-memory` MCP 访问。
  - 本项目只关心：
    - 插入/更新记忆。
    - 按主体/主题检索记忆。
    - 为外部伴学机器人生成建议性更新内容。

- **伴学机器人项目**
  - 不在本项目内实现。
  - 通过数据层（mem0）与本项目共享孩子相关的长期记忆与总结。
  - 本项目可输出“系统提示建议”和“记忆更新建议”，供伴学机器人项目消费。

## 5. 功能需求（按模块）

当前优先定义四个核心模块：

- M1：碎片化输入捕获与任务/记忆更新。
- M2：内容消化与第二大脑更新。
- M3：行业/主题研究管理。
- M4：孩子成长观察与育儿建议。

### 5.1 模块 M1：碎片化输入捕获与任务/记忆更新

#### 5.1.1 目标

- 将 U1 在任意时间提出的自然语言输入（问题、想法、感受等）转化为：
  - 可执行的任务/议题（存入任务系统）。
  - 适合长期保留的记忆片段（写入 mem0）。

#### 5.1.2 输入

- 形式：U1 在 Codex 中的自然语言消息。
- 内容类型（Agent 需自动识别，可多选）：
  - 想法/灵感（Idea）。
  - 研究问题（Research Question）。
  - 决策或反思（Reflection/Decision）。
  - 对孩子相关的观察和感受（Child Observation）。
  - 一般信息性问答（可能无需持久化）。

#### 5.1.3 输出

- 对 U1 的即时反馈：
  - 概要确认（例如：“我已记录为研究任务 #23：…”）。
  - 若无结构化动作，仅给出回答即可。

- 对系统的持久输出：
  - 0～N 条任务记录（通过 `tasks` MCP 创建）。
  - 0～N 条记忆记录（通过 `mem0-memory` MCP 写入）。

#### 5.1.4 行为要求

- **B1：分类与决策**
  - Agent 必须尝试判断当前输入是否需要：
    - 创建/更新任务。
    - 更新长期记忆。
    - 或仅一次性回答。

- **B2：任务创建（对需要行动的内容）**
  - 调用 `tasks.create_task`，字段至少包括：
    - `title`（简短、可读）。
    - `description`（原文或精炼版）。
    - `category`（如：investing, tech, parenting, personal）。
    - `status`（初始为 pending）。
    - `priority`（可选）。
    - `tags`（可选：公司代码、主题名等）。

- **B3：记忆更新（对长期有价值的内容）**
  - 调用 `mem0-memory`，区分不同主体：
    - U1 自身相关：`user_id="U1_USER_ID"`（实际值由配置提供）。
    - 对孩子的观察：`user_id="CHILD_USER_ID"`（实际值由配置提供）。
  - 写入内容应经过必要加工：
    - 从原始话语中提炼出清晰、独立的记忆单元。
    - 附带元信息（日期、主题标签、关联任务 ID 等）。

- **B4：透明反馈**
  - 完成任务/记忆创建后，Agent 应用自然语言向 U1 明确说明做了什么（并提供任务 ID 或简要摘要）。

#### 5.1.5 依赖

- MCP：`tasks`，`mem0-memory`。
- Skills：`capture-idea`（定义该模块的 SOP），后续可扩展其它 Skills。

### 5.2 模块 M2：内容消化与第二大脑更新

#### 5.2.1 目标

- 帮助 U1 将阅读/观看的内容（文章、博客、视频转录、PDF 报告等）转换为结构化知识，写入 mem0，并与现有知识结构关联。

#### 5.2.2 输入

- 内容来源（至少支持以下几类）：
  - 本地文件路径（文章 Markdown/PDF/转录文本）。
  - 直接粘贴的文本。
  - URL（可选，先转为文本再处理）。
  - 视频（可选）：若提供本地视频文件，则先通过 `video_pipeline` 生成 `evidence_compact.md` / `key_metrics.csv`，再作为结构化输入进入本模块；若已有人类转录/正文，则按“本地文件”处理即可。

- U1 可提供的额外信息（可选）：
  - 内容类型（文章/视频/研报/博客等）。
  - 主题标签（如：航天、半导体、教育）。
  - 是否与特定行业/主题研究框架绑定。

#### 5.2.3 输出

- 面向 U1 的结果：
  - 一份结构化摘要，建议包含：
    - 核心观点（不超过 3–7 条）。
    - 支持证据（数据/案例/推理）。
    - 潜在反驳点/局限性。
    - 与 U1 现有观点的一致/冲突点（如果能从记忆/框架中找到）。

- 面向系统的持久化：
  - 记忆条目：写入 mem0（`U1_USER_ID`），内容为高度压缩、有长期价值的“结论/原则/洞见”。
  - （可选）文档索引：若已实现 RAG，则调用 `kb-rag.ingest_document`。

#### 5.2.4 行为要求

- **B1：内容解析**
  - 对于本地文件：通过内置 `workspace` + `shell/python` 工具读取内容。
  - 对于 URL：明确使用 web 搜索/抓取逻辑（后续细化）。

- **B2：结构化摘要**
  - Agent 应按预定义模板进行摘要，强调：
    - 对 U1 实际可用的信息。
    - 与 U1 关注的行业/主题的关联。

- **B3：与现有知识对比**
  - 若可行，调用 `mem0-memory` 查询相关记忆（同一主题/公司/技术），指出：
    - 新内容有哪些新增信息。
    - 哪些地方与过去记忆不一致或需要更新判断。

- **B4：第二大脑更新策略**
  - 不把全文塞进 mem0，而是只写入“长期有价值的精华”，例如：
    - 一条新的投资/技术判断。
    - 对某主题框架的关键补充。
    - 一条会影响你行为/决策的洞见。
  - 在写入前可视情况询问 U1 是否需要写入。

#### 5.2.5 依赖

- MCP：`mem0-memory`，后续可接入 `kb-rag`。
- Tools：`workspace`，`shell`，`python`，`web_search`（视实现而定）。
- Skills：`read-article`、`read-report` 等。

### 5.3 模块 M3：行业/主题研究管理

#### 5.3.1 目标

- 支持 U1 对某个行业或主题（如航天）的长期、系统性研究：
  - 建立研究框架。
  - 挂载资料。
  - 记录进展与状态。
  - 把结论和未解问题显式化。

#### 5.3.2 输入

- 研究对象：
  - 行业（如：半导体、云计算）。
  - 主题（如：航天、AGI 安全）。
- U1 的研究目标：
  - 想回答的核心问题。
  - 时间范围、重点方向等。

#### 5.3.3 输出

- 一个结构化的“研究档案”，包括但不限于：
  - 研究框架（关键问题清单、分析维度）。
  - 重要实体清单（公司、技术、机构、关键人物等）。
  - 当前知识状态（已知/未知/争议点）。
  - 资料挂接（指向本地文件、外部链接、mem0 记忆等）。
  - 后续行动建议（下一步应该研究什么）。

- 持久化方式：
  - 短期（MVP）：文件系统 + mem0：
    - 为每个行业/主题维护一个目录化档案（主 Markdown/JSON + timeline + sources）。
    - 在 mem0 中记录该主题下的重要结论与演化（`topic=<topic_id>` 约定为稳定 slug）。
  - 中长期：可引入 `kb-rag`、`kg-graph` 支撑更复杂查询。

#### 5.3.4 行为要求

- **B1：框架初始化**
  - 当 U1 创建新的行业/主题研究时，Agent 应根据通用最佳实践给出一个初始框架模板（如技术、历史、商业模式、竞争格局、政策、投资逻辑等），由 U1 调整确认。

- **B2：资料挂接**
  - 对每个新 ingest 的文档/资料，Agent 应支持：
    - 将其归类到一个或多个行业/主题。
    - 在对应研究档案中增加“参考资料”条目。

- **B3：进展与状态更新**
  - 支持 U1 询问：
    - “当前航天研究的已知/未知有哪些？”
    - “过去一个月有哪些新进展？”
  - Agent 应结合档案和 mem0，给出结构化回答，并在每次 session 后可更新状态记录。

- **B4：与任务系统协作**
  - 研究过程中发现的新问题或待办事项，应通过 `tasks` MCP 写入任务。
  - 任务完成后可反向更新研究档案的状态。

#### 5.3.5 依赖

- MCP：`mem0-memory`，`tasks`，后续可接入 `kb-rag`、`kg-graph`。
- Tools：`workspace`，`shell`，`python`。
- Skills：`init-research-topic`、`update-research-topic`、`research-session`。

### 5.4 模块 M4：孩子成长观察与育儿建议

#### 5.4.1 目标

- 基于伴学机器人对话记录与 U1 的观察，总结孩子的情绪状态、兴趣发展和行为模式，为 U1 提供育儿建议，并写入长期记忆。

#### 5.4.2 输入

- 来自伴学机器人的对话摘要/日志（由另一个项目生成，格式暂定，待上游 App 稳定后冻结）。
- U1 自己的观察和感受描述。

#### 5.4.3 输出

- 给 U1 的分析与建议：
  - 重点站在儿童心理发展、亲子关系的角度。
  - 注重情绪价值和陪伴质量，而不是学业成绩。
- 写入 mem0 的长期记忆：
  - 孩子画像（兴趣、情绪模式、社交状态等）。
  - 阶段性变化记录。
  - 有效/无效的互动方式总结。
- 给伴学机器人项目的“提示词/记忆更新建议”：
  - 用统一结构输出，便于那边直接拼接到系统提示词或记忆里。
  - 默认以“变更包（JSON）”落盘，必须人工审核后再应用（不自动写入机器人项目/不自动写入孩子侧 mem0）。

#### 5.4.4 行为要求

- 在给出育儿建议前，优先调用 `mem0-memory`：
  - 查看过去关于孩子的 `child_observation` 记忆；
  - 查看 U1 自己的 `parenting_guideline` 记忆。
- 建议内容应避免：
  - 与 U1 既有育儿原则严重冲突而不加说明。
  - 过于极端或直接否定家长期待的表达。
- 对于敏感话题，Agent 可提示 U1 进一步验证或咨询专业人士。

#### 5.4.5 依赖

- MCP：`mem0-memory`。
- Tools：`workspace`（可写本地育儿日志）、`shell`（可选，处理日志）。
- Skills：`child-observation-digest`、`parenting-advice`.

## 6. 接口与数据契约（Contracts）

### 6.1 仓库目录与文件约定（建议）

> 这里定义的是“本项目仓库”的推荐布局，用于约束产物落点与可追溯性。路径可通过配置覆盖，但建议保持一致。

- `mcp-servers/tasks/`：本仓库实现的 `tasks` MCP server 源码与构建产物。
- `mcp-servers/video_pipeline/`：本仓库实现的 `video_pipeline` MCP server 源码与构建产物（本地视频后处理）。
- `skills-src/`：本仓库维护的 Skills（`*/SKILL.md`）；运行时可通过软链/同步到 `~/.codex/skills/`。
- `archives/topics/<topic_id>/`：行业/主题研究档案（M3）。
- `notes/`：通用笔记与研究输出（与 topic 无强绑定的文档）。
- `imports/`：原始输入（默认不入 Git）。
  - `imports/child/`：孩子对话摘要/日志输入（上游 App 产物）。
  - `imports/content/`：文章/转录/报告等原文（可选）。
  - `imports/content/videos/`：本地视频文件（供 `video_pipeline` 处理，默认不入 Git）。
- `exports/`：系统生成的结构化产物（是否入 Git 由你决定）。
  - `exports/robot-update-packages/`：机器人变更包（JSON）。
  - `exports/digests/`：内容消化产物（结构化摘要、要点等，可选）。
- `state/`：本地状态与数据库（默认不入 Git）。
  - `state/tasks.sqlite`：`tasks` MCP 的 SQLite 数据库（若采用 SQLite 实现）。
  - `state/video-analyses/`：视频后处理流水线产物（证据包、关键帧、OCR、转写等）。
- `logs/`：运行日志（默认不入 Git）。

建议的版本控制约束（默认）：

- 必须忽略：`imports/`、`state/`、`logs/`。
- `exports/robot-update-packages/`：
  - 默认可以保留在磁盘但不提交；
  - 如需审计与回放，建议只提交经脱敏且 `review.status=approved` 的变更包。

### 6.2 机器人变更包工作流（S5 / M4）

目标：将孩子相关输入转化为“可审阅、可回放、可选择性应用”的变更建议。

流程（建议）：

1. **导入**：将上游 App 产出的输入文件放入 `imports/child/`（格式暂定，待冻结）。
2. **分析**：Agent 对输入进行后处理，输出：
   - 给 U1 的建议（`u1_advice[]`）。
   - 对机器人/记忆的建议动作（`proposed_actions[]`）。
3. **生成变更包**：写入 `exports/robot-update-packages/`，并设置 `review.status="pending"`。
4. **人工审核**：你阅读/修改（如有必要）后，将 `review.status` 改为 `approved` 或 `rejected`。
5. **应用（手动）**：只有当 `review.status="approved"` 时才允许执行 `proposed_actions[]`：
   - 使用本仓库脚本生成“可应用清单/补丁导出”（默认不写入 mem0）：
     - `python3 scripts/apply_robot_update_package.py exports/robot-update-packages/<file>.json`
   - `mem0.add_memory`：通过外部 `mem0-memory` MCP 写入 mem0（可选择只应用 U1 侧或孩子侧）。
   - `child_bot.prompt_patch`：脚本会导出可复制的提示词片段，不直接修改机器人项目。

变更包格式详见：`robot-update-package-spec.md`。

### 6.3 主题研究档案（M3）

主题研究采用“文件系统档案 + mem0 长期记忆”混合：

- 文件系统用于：
  - 框架、资料索引、时间线、阶段性结论的可读文档化。
- mem0 用于：
  - 高度压缩、可复用的长期结论（`kind=topic_insight` 等）。

约定：

- `topic_id` 为稳定 slug（例如 `space_industry`），用于贯穿：
  - `archives/topics/<topic_id>/`（档案目录）
  - `tasks.topic_id`（任务归档）
  - `mem0.topic=<topic_id>`（记忆归档）

档案结构与模板详见：`topic-archive-spec.md`。

### 6.4 隐私与留存（最小基线）

- 孩子相关原始数据默认不入 Git，存放在 `imports/child/`，并尽量只保留“必要最小化”的字段。
- 机器人变更包默认不包含完整原始对话，只包含摘要与结构化结论；原文通过 `path + hash` 引用定位。
- 对外输出（变更包、日志、研究档案）应避免出现孩子可识别信息（姓名、学校、联系方式等）。
- API Key/Token 一律通过环境变量注入，不写入仓库。

更完整的分级、存放与留存建议见：`privacy-retention-spec.md`。留存周期与访问控制的最终取值仍见：`## 7. 未决事项（TBD）`。

### 6.5 Contracts 文档清单

- `mem0-memory` MCP：见 `mem0-memory-spec.md`（其中的 `U1_USER_ID/CHILD_USER_ID` 由配置注入）。
- `tasks` MCP（本仓库实现）：见 `tasks-mcp-spec.md`。
- `video_pipeline` MCP（本仓库实现）：见 `video-pipeline-mcp-spec.md`。
- 伴学机器人“变更包（JSON）”：见 `robot-update-package-spec.md`（定义输出格式与审核/应用流程）。
- 孩子对话输入（暂定）：在 `robot-update-package-spec.md` 中以“输入包 schema（暂定）”描述，待上游 App 稳定后冻结。
- 主题研究档案（文件系统）：见 `topic-archive-spec.md`。
- 隐私与留存策略：见 `privacy-retention-spec.md`。

## 7. 未决事项（TBD）

- `U1_USER_ID` / `CHILD_USER_ID` 的最终取值与命名空间策略（待你提供现有 mem0 配置后冻结）。
- 孩子对话数据的最终输入格式与导入方式（上游 App 稳定后冻结）。
- `mem0-memory` MCP 的启动方式与参数（stdio 命令或 http url），以便 `scripts/apply_robot_update_package.py --apply-mem0` 直接调用。
- 视频处理流水线的 OCR/表格结构化细则（PP-Structure 等）与最佳抽帧策略（按视频类型调参）。
- 隐私与留存细则：是否存原始对话/全文、保留周期、访问控制、脱敏策略（建议在落地前冻结最低标准）。
